
name: Release

on:
    # Triggers the workflow on push events but only for the master branch
    push:
      tags:
        - "v*"
  
    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:
  

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up GPG
      run: |
        echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --import
        gpg --list-secret-keys --keyid-format LONG
        gpg --list-keys
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}      
    - name: Build linux
      run: cargo build --release --bin satori
      env:
        CARGO_TERM_COLOR: always        
    - name: Sign Binary
      run: |
        gpg --detach-sign -u devops@satoricyber.com -o satori.sig target/release/satori       
    - id: get_version
      uses: battila7/get-version-action@v2
    - name: Create release
      run: |
        zip -jr satori-${{ steps.get_version.outputs.version-without-v }}-linux.zip target/release/satori
        tar czf satori-${{ steps.get_version.outputs.version-without-v }}-linux.tar.gz --directory=target/release satori
    - name: Upload artifacts
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./**/*.tar.gz
          ./**/*.zip
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: rustup
        run: |
            rustup target add x86_64-apple-darwin
      - name: Build linux
        run: cargo build --release --bin satori
        env:
            CARGO_TERM_COLOR: always        
      - id: get_version
        uses: battila7/get-version-action@v2
      - name: Create release
        run: |
            Compress-Archive -Path "target\release\satori.exe" -DestinationPath "satori-${{ steps.get_version.outputs.version-without-v }}-windows.zip"
      - name: Upload artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./**/*.zip
  build-macOS:
      runs-on: macos-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: rustup
          run: |
            rustup target add x86_64-apple-darwin
        - name: Build linux
          run: cargo build --release --bin satori
          env:
            CARGO_TERM_COLOR: always        
        - id: get_version
          uses: battila7/get-version-action@v2
        - name: Create release
          run: |
              zip -jr satori-${{ steps.get_version.outputs.version-without-v }}-macOS.zip target/release/satori
              tar czf satori-${{ steps.get_version.outputs.version-without-v }}-macOS.tar.gz --directory=target/release satori
        - name: Upload artifacts
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          uses: softprops/action-gh-release@v1
          with:
            files: |
              ./**/*.tar.gz
              ./**/*.zip